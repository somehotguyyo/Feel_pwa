<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#f6f6f6" />

  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <title>feel Â· é€‰ä½ çš„é¥­</title>

  <style>
    :root{
      --bg:#f6f6f6;
      --card:rgba(255,255,255,.92);
      --stroke:rgba(0,0,0,.07);
      --text:#111;
      --muted:rgba(0,0,0,.55);
      --shadow:0 18px 60px rgba(0,0,0,.10);
      --shadow2:0 10px 26px rgba(0,0,0,.08);
      --r:28px;
      --ease:cubic-bezier(.2,.9,.2,1);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 50% -140px, rgba(29,116,255,.16), transparent 60%),
        radial-gradient(760px 460px at 12% 18%, rgba(255,153,0,.10), transparent 60%),
        radial-gradient(760px 520px at 88% 16%, rgba(0,0,0,.05), transparent 60%),
        var(--bg);
      -webkit-font-smoothing:antialiased;
      overflow:hidden;
    }

    /* å›ºå®šå·¦ä¸Šè¿”å› */
    .topLeft{
      position:fixed;
      top: calc(12px + env(safe-area-inset-top));
      left: 12px;
      z-index:30;
      display:none;
    }
    .backPill{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.88);
      border-radius:999px;
      padding:10px 14px;
      box-shadow:var(--shadow2);
      font-weight:800;
      color:rgba(0,0,0,.72);
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      cursor:pointer;
    }
    .backPill:active{transform:scale(.98);}

    /* HOME */
    .home{
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding: calc(56px + env(safe-area-inset-top)) 16px 16px;
      overflow:auto;
    }
    .hero{
      width:min(860px,100%);
      text-align:center;
      margin-top: 28px;
      margin-bottom: 18px;
    }
    .title{
      margin:0;
      font-weight:860;
      font-size:34px;
      letter-spacing:-.02em;
      line-height:1.08;
      /* ä½ æƒ³è¦æ›´â€œæ‰‹å†™æ„Ÿâ€ï¼Œä½†åˆä¸å¹¼ç¨šï¼š */
      font-family:"Snell Roundhand","Bradley Hand","Segoe Script",-apple-system,"PingFang SC",sans-serif;
    }
    .subtitle{
      margin:10px 0 0;
      font-size:15.5px;
      color:var(--muted);
      line-height:1.55;
    }

    .grid{
      width:min(860px,100%);
      margin-top: 22px;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:14px;
      padding-bottom: 16px;
    }
    @media (max-width:390px){ .grid{grid-template-columns:1fr;} }

    .stateBtn{
      border:1px solid var(--stroke);
      background:var(--card);
      border-radius:22px;
      padding:18px 16px;
      display:flex;
      align-items:center;
      gap:12px;
      min-height:88px;
      box-shadow:var(--shadow2);
      transition:transform .18s var(--ease), box-shadow .18s var(--ease);
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      cursor:pointer;
    }
    .stateBtn:hover{transform:translateY(-2px); box-shadow:var(--shadow);}
    .stateBtn:active{transform:scale(.985);}

    .emojiCircle{
      width:46px;height:46px;
      border-radius:999px;
      display:grid;
      place-items:center;
      background:rgba(0,0,0,.04);
      border:1px solid rgba(0,0,0,.05);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.8);
      font-size:22px;
      flex:0 0 auto;
    }
    .stateText{min-width:0; display:flex; flex-direction:column; gap:4px;}
    .stateName{font-size:16px;font-weight:780;color:#0b3a8a;letter-spacing:-.01em;}
    .stateHint{font-size:12.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .foot{
      width:min(860px,100%);
      text-align:center;
      font-size:12px;
      color:rgba(0,0,0,.35);
      padding: 10px 0 18px;
    }

    /* RESULT é¡µé¢å¸ƒå±€ï¼šä½ åœˆçš„é‚£å—è¦å¾€ä¸‹ + å±…ä¸­ï¼Œå¹¶ä¸”ä¸è¦ç¦»åº•éƒ¨æŒ‰é’®å¤ªè¿œ */
    .result{
      height:100%;
      display:none;
      padding: calc(56px + env(safe-area-inset-top)) 16px 0;
      overflow:hidden;
    }
    .result.active{display:block;}

    .resultInner{
      height:100%;
      width:min(860px,100%);
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;

      /* âœ… å…³é”®ï¼šä½ åœˆå‡ºæ¥é‚£å—æ•´ä½“å¾€ä¸‹ */
      padding-top: 54px; /* åŸæ¥å¤ªé ä¸Šï¼Œä½ è¦â€œå¾€ä¸‹â€å°±æ˜¯åŠ è¿™ä¸ª */
      /* âœ… åº•éƒ¨ç•™ç»™æŒ‰é’®çš„ç©ºé—´å˜å°ï¼Œè®©æŒ‰é’®é è¿‘å¡ç‰‡ */
      padding-bottom: calc(96px + env(safe-area-inset-bottom));
    }

    .card{
      width:100%;
      border:1px solid var(--stroke);
      background:var(--card);
      border-radius: var(--r);
      padding:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
      animation:fadeIn .22s var(--ease) both;
    }
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(10px);}
      to{opacity:1; transform:translateY(0);}
    }

    .accentBar{
      height:10px;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(29,116,255,.30), rgba(255,153,0,.20));
      margin-bottom:14px;
    }
    .hState{
      margin:0;
      font-size:28px;
      font-weight:900;
      letter-spacing:-.02em;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .hDecide{
      margin:10px 0 0;
      font-size:15px;
      line-height:1.65;
      color:rgba(0,0,0,.70);
      white-space:pre-line;
    }
    .divider{margin:16px 0; height:1px; background:rgba(0,0,0,.06);}
    .labelSmall{
      font-size:12px;
      color:rgba(0,0,0,.45);
      font-weight:900;
      letter-spacing:.02em;
    }
    .dish{
      margin:8px 0 6px;
      font-size:26px;
      font-weight:950;
      letter-spacing:-.02em;
      transition:opacity .14s var(--ease);
    }
    .dishMeta{
      margin:0;
      font-size:13px;
      color:rgba(0,0,0,.52);
      line-height:1.55;
      transition:opacity .14s var(--ease);
    }
    .ritual{
      margin-top:14px;
      border:1px solid rgba(0,0,0,.06);
      background:rgba(0,0,0,.03);
      border-radius:18px;
      padding:14px;
      font-size:14px;
      line-height:1.6;
      color:rgba(0,0,0,.72);
    }
    .ritual b{display:block; margin-bottom:6px;}

    /* åº•éƒ¨æŒ‰é’®ï¼šå›ºå®šé ä¸‹ï¼Œä½†è·ç¦»å¡ç‰‡ä¸è¦å¤ªè¿œ */
    .actions{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(18px + env(safe-area-inset-bottom)); /* âœ… æ›´è´´è¿‘åº•éƒ¨ */
      width:min(860px, calc(100% - 24px));
      display:none;
      z-index:25;
    }
    .actions.active{display:block;}

    .actionsRow{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
    }
    .btn{
      border-radius:999px;
      padding:14px 16px;
      font-weight:900;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.88);
      box-shadow:var(--shadow2);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      display:flex;
      justify-content:center;
      align-items:center;
      min-width:0;
      transition:transform .15s var(--ease), opacity .15s var(--ease);
    }
    .btn:active{transform:scale(.985);}
    .btn.primary{
      background:#111;
      color:#fff;
      border-color:rgba(0,0,0,.22);
    }
    .btn.ghost{
      background:rgba(255,255,255,.74);
      color:#0b3a8a;
    }
    .btn.wide{flex:1;}
    .btn.mid{flex:1;}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(86px + env(safe-area-inset-bottom)); /* âœ… ç¦»æŒ‰é’®æ›´è¿‘ä¸€ç‚¹ */
      background:rgba(17,17,17,.92);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:13px;
      box-shadow:0 14px 40px rgba(0,0,0,.22);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s var(--ease), transform .18s var(--ease);
      z-index:99;
      max-width:calc(100% - 24px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }
  </style>
</head>

<body>

  <!-- å·¦ä¸Šè¿”å› -->
  <div class="topLeft" id="topLeft">
    <div class="backPill" id="backBtn">â† å›é¦–é¡µ</div>
  </div>

  <!-- HOME -->
  <section class="home" id="home">
    <div class="hero">
      <h1 class="title">è¯´ä½ çš„ feelï¼Œé€‰ä½ çš„é¥­</h1>
      <p class="subtitle">ä¸ç”¨æƒ³,æˆ‘æ›¿ä½ åšä¸€ä¸ªå†³å®šã€‚</p>
    </div>

    <div class="grid" id="grid"></div>

    <div class="foot">V1ï¼šå…ˆæŠŠâ€œå†³å®šâ€å’Œâ€œå¯ä¿¡åº¦â€åšå¯¹ï¼›èªæ˜å’Œä¸ªæ€§åŒ–æ”¾åˆ°åæœŸã€‚</div>
  </section>

  <!-- RESULT -->
  <section class="result" id="result">
    <div class="resultInner">
      <div class="card">
        <div class="accentBar" id="accentBar"></div>
        <h2 class="hState" id="stateTitle">ğŸ™‚</h2>
        <p class="hDecide" id="stateDecide">â€¦</p>

        <div class="divider"></div>

        <div class="labelSmall">ä»Šå¤©å°±ç‚¹è¿™ä¸ª</div>
        <div class="dish" id="dishText">â€”</div>
        <p class="dishMeta" id="dishMeta">â€”</p>

        <div class="ritual" id="ritualBox">
          <b>ä»ªå¼æ„Ÿï¼ˆå¯é€‰ï¼‰</b>
          æ‰“å¼€ä¸€é¦–å–œæ¬¢çš„æ­Œï¼ŒæŠŠè¿™ä¸€é¡¿åƒå®Œã€‚
        </div>
      </div>
    </div>
  </section>

  <!-- åº•éƒ¨æŒ‰é’® -->
  <div class="actions" id="actions">
    <div class="actionsRow">
      <div class="btn primary wide" id="goBtn">å»ç‚¹å¤–å–</div>
      <div class="btn ghost mid" id="swapBtn">æ¢ä¸€ä¸ª</div>
      <div class="btn mid" id="changeBtn">æ¢ä¸ªçŠ¶æ€</div>
    </div>
  </div>

  <div class="toast" id="toast">åƒé¥±äº†å°±å¼€å¿ƒå•¦âœ¨</div>

  <script>
    /**********************
     * æ–‡æ¡ˆ/çŠ¶æ€
     **********************/
    const STATE_UI = {
      tired:  { emoji:"ğŸ˜®â€ğŸ’¨", name:"ç´¯",
        decide:"ç°åœ¨è¿™ç§æƒ…å†µï¼Œ\nç›´æ¥åƒä¸€ä»½çƒ­çš„ã€æœ‰è›‹ç™½çš„ä¸»é£Ÿã€‚\nè®©å®ƒæŠŠä½ æ‹‰å›çŠ¶æ€ã€‚",
        accent:"linear-gradient(90deg, rgba(29,116,255,.30), rgba(0,0,0,.06))",
        ritual:"å…ˆå–ä¸¤å£çƒ­çš„ï¼Œå†å¼€åƒã€‚"
      },
      sad:    { emoji:"â˜¹ï¸", name:"å¿ƒæƒ…ä¸å¥½",
        decide:"ç°åœ¨è¿™ç§æƒ…å†µï¼Œ\næ¥ä¸€ä»½ç†Ÿæ‚‰çš„é¥­å’Œèƒ½é‡ã€‚\nè§¦åº•åå¼¹ä»èƒƒé‡Œå¼€å§‹ã€‚",
        accent:"linear-gradient(90deg, rgba(255,153,0,.26), rgba(29,116,255,.12))",
        ritual:"äº”åˆ†é’Ÿåªç®¡åƒï¼Œåˆ«ç®¡ä¸–ç•Œã€‚"
      },
      reward: { emoji:"ğŸ˜Œ", name:"æƒ³å¥–åŠ±è‡ªå·±",
        decide:"ç°åœ¨è¿™ç§æƒ…å†µï¼Œ\nç‚¹ä¸€ä»½æœ€â€œå€¼å¾—â€çš„ä¸œè¥¿ã€‚\nä½ å€¼å¾—æŠŠä»Šå¤©æ”¶å¥½ã€‚",
        accent:"linear-gradient(90deg, rgba(0,0,0,.10), rgba(255,153,0,.22))",
        ritual:"æ‰“å¼€ä½ æœ€çˆ±çš„æ­Œï¼ŒæŠŠè¿™ä¸€é¡¿å½“æˆå¥–æ¯ã€‚"
      },
      rush:   { emoji:"ğŸ•™", name:"èµ¶æ—¶é—´",
        decide:"ç°åœ¨è¿™ç§æƒ…å†µï¼Œ\né€‰æœ€å¿«ã€æœ€ç¨³çš„ä¸€é¤ã€‚\næ•ˆç‡ä¼˜å…ˆï¼Œåˆ«çº ç»“ã€‚",
        accent:"linear-gradient(90deg, rgba(29,116,255,.26), rgba(0,0,0,.08))",
        ritual:"å…ˆä¸‹å•ï¼šåƒä¸åƒå¾—ç²¾è‡´å…ˆåˆ«ç®¡ã€‚"
      },
      decide: { emoji:"ğŸ¤”", name:"ä½ æ¥å†³å®š",
        decide:"ç°åœ¨è¿™ç§æƒ…å†µï¼Œ\næ¥ä»½ä¸åã€ä¸åˆºæ¿€ã€ä¹Ÿä¸ç³Ÿç³•çš„ä¸€é¤ã€‚\nç¨³ä½å°±èµ¢ã€‚",
        accent:"linear-gradient(90deg, rgba(0,0,0,.06), rgba(29,116,255,.18))",
        ritual:"åƒå®Œå†åšä¸‹ä¸€ä»¶äº‹ã€‚"
      }
    };

    const HOME_BTNS = [
      { key:"tired",  hint:"çƒ­çš„ã€èƒ½é¡¶ä½" },
      { key:"sad",    hint:"ç†Ÿæ‚‰çš„é¥­ï¼Œç¨³ä¸€ä¸‹" },
      { key:"reward", hint:"ä»Šå¤©å€¼å¾—" },
      { key:"rush",   hint:"æœ€å¿«è§£å†³" },
      { key:"decide", hint:"æˆ‘æ¥æŒ‘ä¸€ä¸ªç¨³çš„" },
    ];

    /**********************
     * èœå“ï¼ˆç¤ºä¾‹ 60ï¼Œåç»­å¯åŠ åˆ° 200ï¼‰
     **********************/
    function toKW(label){
      return label
        .replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, "")
        .replace(/\s*\+\s*/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    const DISHES = [
      // noodle
      { id:"N01", label:"æ¸…æ±¤ç‰›è‚‰é¢", cat:"noodle" },
      { id:"N02", label:"çº¢çƒ§ç‰›è‚‰é¢", cat:"noodle" },
      { id:"N03", label:"ç‰›è…©é¢", cat:"noodle" },
      { id:"N04", label:"é¸¡æ±¤é¢", cat:"noodle" },
      { id:"N05", label:"æ’éª¨æ±¤é¢", cat:"noodle" },
      { id:"N06", label:"é¦„é¥¨é¢", cat:"noodle" },
      { id:"N07", label:"ç‚¸é…±é¢", cat:"noodle" },
      { id:"N08", label:"è‘±æ²¹æ‹Œé¢", cat:"noodle" },
      { id:"N09", label:"æ‹…æ‹…é¢", cat:"noodle" },
      { id:"N10", label:"ç‰›è‚‰ç²‰ä¸æ±¤", cat:"noodle" },
      { id:"N11", label:"é…¸è¾£ç²‰", cat:"noodle" },
      { id:"N12", label:"å¹¿å¼ç‚’æ²³ç²‰", cat:"noodle" },

      // rice
      { id:"R13", label:"ç•ªèŒ„ç‚’è›‹ + ç±³é¥­", cat:"rice" },
      { id:"R14", label:"é’æ¤’é¸¡è›‹ + ç±³é¥­", cat:"rice" },
      { id:"R15", label:"ç…§çƒ§é¸¡è…¿ + ç±³é¥­", cat:"rice" },
      { id:"R16", label:"å’–å–±é¸¡ + ç±³é¥­", cat:"rice" },
      { id:"R17", label:"é»‘æ¤’ç‰›æŸ³ + ç±³é¥­", cat:"rice" },
      { id:"R18", label:"çº¢çƒ§ç‰›è‚‰ + ç±³é¥­ï¼ˆå¤šè‚‰ï¼‰", cat:"rice" },
      { id:"R19", label:"é»„ç„–é¸¡ + ç±³é¥­ï¼ˆåé‡å£ï¼‰", cat:"rice" },
      { id:"R20", label:"æ–°ç–†æŠ“é¥­ï¼ˆç‰›è‚‰ï¼‰", cat:"rice" },
      { id:"R21", label:"çƒ¤è‚‰æ‹Œé¥­", cat:"rice" },
      { id:"R22", label:"éº»å©†è±†è… + ç±³é¥­", cat:"rice" },

      // soft
      { id:"S23", label:"çš®è›‹ç˜¦è‚‰ç²¥ï¼ˆçƒ­çš„ï¼‰", cat:"soft" },
      { id:"S24", label:"å°ç±³ç²¥ + å°èœ", cat:"soft" },
      { id:"S25", label:"ç´«èœè›‹èŠ±æ±¤ + ç±³é¥­", cat:"soft" },
      { id:"S26", label:"å†¬ç“œæ’éª¨æ±¤", cat:"soft" },
      { id:"S27", label:"ç•ªèŒ„ç‰›è…©æ±¤", cat:"soft" },

      // fast
      { id:"F28", label:"ç»å…¸ç‰›è‚‰æ±‰å ¡", cat:"fast" },
      { id:"F29", label:"é¸¡è‚‰å·", cat:"fast" },
      { id:"F30", label:"é¦™çƒ¤ç‰›è‚‰ä¸‰æ˜æ²»", cat:"fast" },
      { id:"F31", label:"æŠ«è¨ï¼ˆå•äººä»½ï¼‰", cat:"fast" },
      { id:"F32", label:"ç‚¸é¸¡å¥—é¤", cat:"fast" },
      { id:"F33", label:"é¥­å›¢/ä¾¿å½“ï¼ˆå³å–ï¼‰", cat:"fast" },

      // heavy
      { id:"H34", label:"çº¢çƒ§æ’éª¨ + ç±³é¥­", cat:"heavy" },
      { id:"H35", label:"å›é”…è‚‰ + ç±³é¥­", cat:"heavy" },
      { id:"H36", label:"éº»è¾£é¦™é”…", cat:"heavy" },
      { id:"H37", label:"çƒ§çƒ¤æ‹¼ç›˜", cat:"heavy" },
      { id:"H38", label:"ç‚¸çŒªæ’å¥—é¤", cat:"heavy" },

      // sweet
      { id:"T39", label:"å¥¶èŒ¶", cat:"sweet" },
      { id:"T40", label:"ææ‹‰ç±³è‹", cat:"sweet" },
      { id:"T41", label:"å†°æ·‡æ·‹", cat:"sweet" },

      // å†è¡¥ä¸€äº›é¿å…å¤ªå°‘
      { id:"N42", label:"æ—¥å¼è±šéª¨æ‹‰é¢", cat:"noodle" },
      { id:"N43", label:"æµ·é²œæ±¤é¢", cat:"noodle" },
      { id:"R44", label:"é…¸ç”œå£è‚‰ä¸ + ç±³é¥­", cat:"rice" },
      { id:"R45", label:"é¸¡ä¸ + ç±³é¥­ï¼ˆä¸è¾£ï¼‰", cat:"rice" },
      { id:"S46", label:"ç™½ç²¥ + å’¸èœ", cat:"soft" },
      { id:"S47", label:"å—ç“œç²¥", cat:"soft" },
      { id:"F48", label:"ç«è…¿èŠå£«ä¸‰æ˜æ²»", cat:"fast" },
      { id:"F49", label:"å¢¨è¥¿å“¥é¸¡è‚‰å·é¥¼", cat:"fast" },
      { id:"H50", label:"ç‚¸é¸¡è…¿ï¼ˆé‡æ»¡è¶³ï¼‰", cat:"heavy" },
      { id:"N51", label:"ç‰›è‚‰æ‹Œé¢", cat:"noodle" },
      { id:"R52", label:"ç™½åˆ‡é¸¡ + ç±³é¥­ï¼ˆä¸æ²¹ä¸è¾£ï¼‰", cat:"rice" },
      { id:"R53", label:"æ¸…è’¸é±¼ + ç±³é¥­", cat:"rice" },
      { id:"N54", label:"é…¸èœè‚‰ä¸é¢", cat:"noodle" },
      { id:"R55", label:"è±†è…ç‰›è‚‰ + ç±³é¥­ï¼ˆå¾®è¾£ï¼‰", cat:"rice" },
      { id:"S56", label:"æ’éª¨æ±¤ + ç±³é¥­", cat:"soft" },
      { id:"F57", label:"è–¯æ¡ + é¥®æ–™ï¼ˆåº”æ€¥ï¼‰", cat:"fast" },
      { id:"N58", label:"æ¸…æ±¤é¸¡ä¸é¢", cat:"noodle" },
      { id:"R59", label:"é¸¡ä¸è”¬èœ + ç±³é¥­", cat:"rice" },
      { id:"S60", label:"é¸¡ä¸ç²¥", cat:"soft" },
    ].map(d => ({ ...d, kw: toKW(d.label) }));

    const POOLS = {
      noodle: DISHES.filter(d=>d.cat==="noodle"),
      rice:   DISHES.filter(d=>d.cat==="rice"),
      soft:   DISHES.filter(d=>d.cat==="soft"),
      fast:   DISHES.filter(d=>d.cat==="fast"),
      heavy:  DISHES.filter(d=>d.cat==="heavy"),
      sweet:  DISHES.filter(d=>d.cat==="sweet"),
    };

    const WEIGHTS = {
      tired:  { noodle: 44, soft: 28, rice: 22, fast: 6,  heavy: 0,  sweet: 0 },
      sad:    { rice:   38, noodle: 32, soft: 18, fast: 6,  heavy: 0,  sweet: 6 },
      reward: { heavy:  34, fast:  28, noodle: 18, rice: 12, soft: 0,  sweet: 8 },
      rush:   { fast:   52, rice:  28, noodle: 12, soft: 8,  heavy: 0,  sweet: 0 },
      decide: { noodle: 40, rice:  34, soft: 20, fast: 6,  heavy: 0,  sweet: 0 },
    };

    function weightedPick(obj){
      const entries = Object.entries(obj).filter(([,w])=>w>0);
      const total = entries.reduce((s,[,w])=>s+w,0);
      let r = Math.random() * total;
      for(const [k,w] of entries){
        r -= w;
        if(r <= 0) return k;
      }
      return entries[entries.length-1][0];
    }
    function pickOne(arr, avoidId){
      if(!arr || arr.length===0) return null;
      if(!avoidId) return arr[Math.floor(Math.random()*arr.length)];
      const filtered = arr.filter(x=>x.id!==avoidId);
      const pickArr = filtered.length ? filtered : arr;
      return pickArr[Math.floor(Math.random()*pickArr.length)];
    }
    function pickByMood(moodKey, lastId){
      const w = WEIGHTS[moodKey] || WEIGHTS.decide;
      const cat = weightedPick(w);
      const dish = pickOne(POOLS[cat], lastId);
      return dish || pickOne(DISHES, lastId);
    }

    /**********************
     * DOM
     **********************/
    const homeEl = document.getElementById("home");
    const resEl  = document.getElementById("result");
    const actionsEl = document.getElementById("actions");
    const topLeftEl = document.getElementById("topLeft");

    const gridEl = document.getElementById("grid");
    const backBtn = document.getElementById("backBtn");
    const goBtn = document.getElementById("goBtn");
    const swapBtn = document.getElementById("swapBtn");
    const changeBtn = document.getElementById("changeBtn");

    const accentBar = document.getElementById("accentBar");
    const stateTitle = document.getElementById("stateTitle");
    const stateDecide = document.getElementById("stateDecide");
    const dishText = document.getElementById("dishText");
    const dishMeta = document.getElementById("dishMeta");
    const ritualBox = document.getElementById("ritualBox");

    const toast = document.getElementById("toast");

    let currentMood = null;
    let currentDish = null;
    let lastDishId  = null;
    let jumpedOut   = false;

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), 1400);
    }

    function setView(view){
      const isHome = view === "home";
      homeEl.style.display = isHome ? "flex" : "none";
      resEl.classList.toggle("active", !isHome);
      actionsEl.classList.toggle("active", !isHome);
      topLeftEl.style.display = isHome ? "none" : "block";
    }

    function renderResult(){
      const ui = STATE_UI[currentMood] || STATE_UI.decide;

      accentBar.style.background = ui.accent;
      stateTitle.textContent = `${ui.emoji} ${ui.name}`;
      stateDecide.textContent = ui.decide;

      dishText.textContent = currentDish?.label || "â€”";
      dishMeta.textContent = currentDish
        ? `å…³é”®è¯ï¼š${currentDish.kw} Â· åˆ†ç±»ï¼š${currentDish.cat}`
        : "â€”";

      ritualBox.innerHTML = `<b>ä»ªå¼æ„Ÿï¼ˆå¯é€‰ï¼‰</b>${ui.ritual}`;

      setView("result");
    }

    function pickMood(key){
      currentMood = key;
      currentDish = pickByMood(currentMood, lastDishId);
      lastDishId = currentDish?.id || null;
      renderResult();
    }

    function swapDish(){
      currentDish = pickByMood(currentMood || "decide", lastDishId);
      lastDishId = currentDish?.id || null;

      dishText.style.opacity = "0";
      dishMeta.style.opacity = "0";
      setTimeout(()=>{
        dishText.textContent = currentDish?.label || "â€”";
        dishMeta.textContent = currentDish
          ? `å…³é”®è¯ï¼š${currentDish.kw} Â· åˆ†ç±»ï¼š${currentDish.cat}`
          : "â€”";
        dishText.style.opacity = "1";
        dishMeta.style.opacity = "1";
      }, 90);
    }

    /**********************
     * äºŒæ¬¡ç¡®è®¤å”¤é†’ç¾å›¢ Appï¼ˆå¿…é¡»ï¼‰
     **********************/
    let needConfirmOpen = false;
    let confirmTimer = null;

    function meituanSchemeURL(kw){
      return "meituanwaimai://waimai.meituan.com/search?query=" + encodeURIComponent(kw);
    }

    function openMeituanNow(kw){
      const url = meituanSchemeURL(kw);

      // iOS/PWA æ›´ç¨³ï¼šiframe åŒæ­¥è§¦å‘ scheme
      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = url;
      document.body.appendChild(iframe);

      setTimeout(() => {
        try { document.body.removeChild(iframe); } catch(e) {}
      }, 700);
    }

    function resetConfirm(){
      needConfirmOpen = false;
      clearTimeout(confirmTimer);
      goBtn.textContent = "å»ç‚¹å¤–å–";
    }

    function goWaimai(){
      const kw = (currentDish?.kw || currentDish?.label || "").trim();
      if(!kw){
        showToast("å…ˆé€‰ä¸€ä¸ªå†å»ç‚¹å¤–å–ğŸ™‚");
        return;
      }

      // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šè¿›å…¥ç¡®è®¤æ€ï¼ˆ10ç§’ï¼‰
      if(!needConfirmOpen){
        needConfirmOpen = true;
        goBtn.textContent = "ç¡®è®¤æ‰“å¼€ç¾å›¢App";
        showToast("å†ç‚¹ä¸€æ¬¡ï¼Œç¡®è®¤æ‰“å¼€ç¾å›¢App");

        clearTimeout(confirmTimer);
        confirmTimer = setTimeout(()=>{
          resetConfirm();
          showToast("å·²å–æ¶ˆç¡®è®¤");
        }, 10000);

        return;
      }

      // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼šçœŸæ­£å”¤é†’
      resetConfirm();
      jumpedOut = true;
      showToast("æ­£åœ¨æ‰“å¼€ç¾å›¢Appâ€¦");
      openMeituanNow(kw);
    }

    // ä»å¤–å–å›æ¥å¼¹ä¸€å¥ + é‡ç½®ç¡®è®¤æ€
    document.addEventListener("visibilitychange", ()=>{
      if(document.visibilityState === "visible" && jumpedOut){
        jumpedOut = false;
        resetConfirm();
        showToast(Math.random() < 0.5 ? "å¤šåƒç‚¹ğŸ™‚" : "åƒé¥±äº†å°±å¼€å¿ƒå•¦âœ¨");
      }
    });

    /**********************
     * ç»‘å®š
     **********************/
    backBtn.addEventListener("click", ()=> { resetConfirm(); setView("home"); });
    changeBtn.addEventListener("click", ()=> { resetConfirm(); setView("home"); });
    swapBtn.addEventListener("click", swapDish);
    goBtn.addEventListener("click", goWaimai);

    function buildHome(){
      gridEl.innerHTML = "";
      HOME_BTNS.forEach(({key, hint})=>{
        const ui = STATE_UI[key];
        const btn = document.createElement("div");
        btn.className = "stateBtn";
        btn.innerHTML = `
          <div class="emojiCircle">${ui.emoji}</div>
          <div class="stateText">
            <div class="stateName">${ui.name}</div>
            <div class="stateHint">${hint}</div>
          </div>
        `;
        btn.addEventListener("click", ()=> pickMood(key));
        gridEl.appendChild(btn);
      });
    }

    buildHome();
    setView("home");
  </script>
</body>
</html>
