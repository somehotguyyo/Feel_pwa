<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#f7f7f7" />

  <!-- ä½ ä»“åº“é‡Œå¦‚æœå·²æœ‰ manifest.json / iconsï¼Œè¯·ä¿ç•™è¿™ä¸¤è¡Œï¼›æ²¡æœ‰ä¹Ÿä¸å½±å“ç½‘é¡µè¿è¡Œ -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <title>feel Â· é€‰ä½ çš„é¥­</title>

  <style>
    :root{
      --bg: #f7f7f7;
      --card: rgba(255,255,255,.86);
      --card2: rgba(255,255,255,.96);
      --stroke: rgba(0,0,0,.06);
      --text: #111;
      --muted: rgba(0,0,0,.55);
      --blue: #1d74ff;
      --shadow: 0 18px 50px rgba(0,0,0,.08);
      --shadow2: 0 6px 18px rgba(0,0,0,.06);
      --r: 22px;
      --pad: 18px;
      --ease: cubic-bezier(.2,.9,.2,1);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text",
        "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 50% -120px, rgba(29,116,255,.16), transparent 60%),
        radial-gradient(700px 380px at 12% 20%, rgba(255,153,0,.10), transparent 60%),
        radial-gradient(700px 420px at 88% 26%, rgba(0,0,0,.05), transparent 60%),
        var(--bg);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      overflow-x:hidden;
    }

    .wrap{
      max-width: 860px;
      margin: 0 auto;
      padding: 22px 16px 120px;
    }

    /* é¡¶éƒ¨ï¼šå±…ä¸­ */
    .hero{
      text-align:center;
      padding-top: 22px;
      padding-bottom: 8px;
    }
    .title{
      margin:0;
      font-weight: 780;
      font-size: 34px;
      letter-spacing: -0.02em;
      line-height: 1.1;
      /* â€œæ‰‹å†™æ„Ÿâ€ï¼šä¼˜å…ˆç”¨ iOS è‡ªå¸¦çš„æ‰‹å†™å­—ä½“ï¼Œæ²¡æœ‰å°±å›é€€ */
      font-family: "Snell Roundhand", "Segoe Script", "Bradley Hand", -apple-system, "PingFang SC", sans-serif;
    }
    .subtitle{
      margin: 10px 0 0;
      font-size: 15.5px;
      color: var(--muted);
      line-height: 1.5;
    }

    /* é€‰é¡¹æ•´ä½“å¾€ä¸‹ */
    .grid{
      margin-top: 34px; /* ğŸ‘ˆ é€‰é¡¹å¾€ä¸‹ */
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }
    @media (max-width: 380px){
      .grid{ grid-template-columns: 1fr; }
    }

    .stateBtn{
      border: 1px solid var(--stroke);
      background: var(--card);
      border-radius: 22px;
      padding: 18px 16px;
      display:flex;
      gap: 12px;
      align-items:center;
      min-height: 86px;
      box-shadow: var(--shadow2);
      transition: transform .18s var(--ease), box-shadow .18s var(--ease), background .18s var(--ease);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor:pointer;
    }
    .stateBtn:active{
      transform: scale(.985);
    }
    .stateBtn:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      background: var(--card2);
    }

    .emojiCircle{
      width: 44px; height: 44px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.04);
      border: 1px solid rgba(0,0,0,.05);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
      flex: 0 0 auto;
      font-size: 22px;
    }

    .stateText{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }
    .stateName{
      font-size: 16px;
      font-weight: 720;
      letter-spacing: -0.01em;
      color: #0b3a8a;
    }
    .stateHint{
      font-size: 12.5px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .foot{
      margin-top: 16px;
      text-align:center;
      font-size: 12px;
      color: rgba(0,0,0,.35);
    }

    /* ç»“æœé¡µ */
    .view{
      display:none;
      animation: fadeIn .22s var(--ease) both;
    }
    .view.active{ display:block; }

    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
    }

    .pill{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.75);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: var(--shadow2);
      color: rgba(0,0,0,.70);
      font-weight: 650;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .pill:active{ transform: scale(.98); }

    .card{
      margin-top: 16px;
      border: 1px solid var(--stroke);
      background: var(--card2);
      border-radius: 28px;
      padding: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .accentBar{
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(29,116,255,.30), rgba(255,153,0,.20));
      filter: blur(.2px);
      margin-bottom: 14px;
    }

    .hState{
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 26px;
      font-weight: 820;
      letter-spacing:-.02em;
      margin: 0;
    }
    .hDecide{
      margin: 10px 0 0;
      color: rgba(0,0,0,.68);
      line-height:1.55;
      font-size: 15px;
      white-space: pre-line;
    }

    .divider{
      margin: 16px 0;
      height: 1px;
      background: rgba(0,0,0,.06);
    }

    .labelSmall{
      font-size: 12px;
      color: rgba(0,0,0,.45);
      font-weight: 700;
      letter-spacing:.02em;
      text-transform: none;
    }

    .dish{
      margin: 8px 0 6px;
      font-size: 24px;
      font-weight: 860;
      letter-spacing:-.02em;
    }
    .dishMeta{
      margin: 0;
      font-size: 13px;
      color: rgba(0,0,0,.52);
      line-height: 1.5;
    }

    .ritual{
      margin-top: 14px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(0,0,0,.03);
      border-radius: 18px;
      padding: 14px;
      color: rgba(0,0,0,.70);
      line-height:1.55;
      font-size: 14px;
    }
    .ritual b{ display:block; margin-bottom:6px; }

    /* åº•éƒ¨æ“ä½œæ  */
    .sticky{
      position: fixed;
      left:0; right:0;
      bottom: 0;
      padding: 12px 14px calc(12px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(247,247,247,0), rgba(247,247,247,.86) 22%, rgba(247,247,247,.96));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0,0,0,.06);
      display:none;
      z-index: 50;
    }
    .sticky.active{ display:block; }

    .actions{
      max-width: 860px;
      margin: 0 auto;
      display:flex;
      gap: 10px;
    }

    .btn{
      border-radius: 999px;
      padding: 14px 16px;
      font-weight: 760;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.85);
      box-shadow: var(--shadow2);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      flex:1;
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 8px;
      transition: transform .15s var(--ease), box-shadow .15s var(--ease);
    }
    .btn:active{ transform: scale(.985); }

    .btn.primary{
      background: #111;
      color:#fff;
      border-color: rgba(0,0,0,.22);
    }
    .btn.ghost{
      background: rgba(255,255,255,.70);
      color: #0b3a8a;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 88px;
      transform: translateX(-50%);
      background: rgba(17,17,17,.92);
      color:#fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 14px 40px rgba(0,0,0,.22);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s var(--ease), transform .18s var(--ease);
      z-index: 99;
      max-width: calc(100% - 24px);
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- HOME -->
    <section id="home" class="view active">
      <div class="hero">
        <h1 class="title">è¯´ä½ çš„ feelï¼Œé€‰ä½ çš„é¥­</h1>
        <p class="subtitle">ä¸ç”¨æƒ³ã€‚æˆ‘æ›¿ä½ åšä¸€ä¸ªä¸åæ‚”çš„å†³å®šã€‚</p>
      </div>

      <div class="grid" id="stateGrid">
        <!-- buttons injected by JS -->
      </div>

      <div class="foot">V1ï¼šå…ˆæŠŠâ€œå†³å®šâ€å’Œâ€œå¯ä¿¡åº¦â€åšå¯¹ï¼›èªæ˜å’Œä¸ªæ€§åŒ–æ”¾åˆ°åæœŸã€‚</div>
    </section>

    <!-- RESULT -->
    <section id="result" class="view">
      <div class="topRow">
        <div class="pill" id="backBtn">â† å›é¦–é¡µ</div>
      </div>

      <div class="card">
        <div class="accentBar" id="accentBar"></div>
        <h2 class="hState" id="stateTitle">ğŸ™‚</h2>
        <p class="hDecide" id="stateDecide">â€¦</p>

        <div class="divider"></div>

        <div class="labelSmall">ä»Šå¤©å°±ç‚¹è¿™ä¸ª</div>
        <div class="dish" id="dishText">â€”</div>
        <p class="dishMeta" id="dishMeta">â€”</p>

        <div class="ritual" id="ritualBox">
          <b>ä»ªå¼æ„Ÿï¼ˆå¯é€‰ï¼‰</b>
          åä¸‹ï¼Œæ‰“å¼€ä¸€é¦–å–œæ¬¢çš„æ­Œï¼ŒæŠŠè¿™ä¸€é¡¿åƒå®Œã€‚
        </div>
      </div>
    </section>
  </div>

  <!-- Bottom bar -->
  <div class="sticky" id="sticky">
    <div class="actions">
      <div class="btn primary" id="goBtn">å»ç‚¹å¤–å–</div>
      <div class="btn ghost" id="swapBtn">æ¢ä¸€ä¸ª</div>
      <div class="btn" id="changeBtn">æ¢ä¸ªçŠ¶æ€</div>
    </div>
  </div>

  <div class="toast" id="toast">åƒé¥±äº†å°±å¼€å¿ƒå•¦âœ¨</div>

  <script>
    /**********************
     * 0) çŠ¶æ€æ–‡æ¡ˆï¼ˆåªæ”¾ UI æ–‡æ¡ˆï¼Œä¸æ”¾èœï¼‰
     **********************/
    const STATE_UI = {
      tired:  {
        emoji:"ğŸ˜®â€ğŸ’¨",
        name:"ç´¯",
        decide:"ç°åœ¨è¿™ç§æƒ…å†µï¼Œ\næ¥ä»½çƒ­çš„ã€èƒ½é¡¶ä½çš„ä¸»é£Ÿã€‚\nå…ˆæŠŠçŠ¶æ€æ‹‰å›æ¥ï¼Œå†ç»§ç»­æˆ˜æ–—ã€‚",
        accent:"linear-gradient(90deg, rgba(29,116,255,.30), rgba(0,0,0,.06))",
        ritual:"æŠŠçƒ­çš„ç«¯ç¨³ï¼šåä¸‹ï¼Œå–ä¸¤å£æ±¤å†å¼€åƒã€‚"
      },
      sad:    {
        emoji:"â˜¹ï¸",
        name:"å¿ƒæƒ…ä¸å¥½",
        decide:"ç°åœ¨è¿™ç§æƒ…å†µï¼Œ\næ¥ä¸€ä»½ç†Ÿæ‚‰çš„é¥­å’Œèƒ½é‡ã€‚\næƒ…ç»ªè§¦åº•åå¼¹ï¼Œä»èƒƒé‡Œå¼€å§‹ã€‚",
        accent:"linear-gradient(90deg, rgba(255,153,0,.26), rgba(29,116,255,.12))",
        ritual:"åˆ«è¾¹åˆ·è¾¹åƒï¼šäº”åˆ†é’Ÿåªç®¡åƒï¼Œåˆ«ç®¡ä¸–ç•Œã€‚"
      },
      reward: {
        emoji:"ğŸ˜Œ",
        name:"æƒ³å¥–åŠ±è‡ªå·±",
        decide:"ç°åœ¨è¿™ç§æƒ…å†µï¼Œ\nç‚¹ä¸€ä»½æœ€â€œå€¼å¾—â€çš„ä¸œè¥¿ã€‚\nä½ å€¼å¾—æŠŠä»Šå¤©æ”¶å¥½ã€‚",
        accent:"linear-gradient(90deg, rgba(0,0,0,.10), rgba(255,153,0,.22))",
        ritual:"æ‰“å¼€ä½ æœ€çˆ±çš„æ­Œï¼ŒæŠŠè¿™ä¸€é¡¿å½“æˆå¥–æ¯ã€‚"
      },
      rush:   {
        emoji:"ğŸ•™",
        name:"èµ¶æ—¶é—´",
        decide:"ç°åœ¨è¿™ç§æƒ…å†µï¼Œ\né€‰æœ€å¿«ã€æœ€ç¨³çš„ä¸€é¤ã€‚\næ•ˆç‡ä¼˜å…ˆï¼Œåˆ«çº ç»“ã€‚",
        accent:"linear-gradient(90deg, rgba(29,116,255,.26), rgba(0,0,0,.08))",
        ritual:"å…ˆä¸‹å•ï¼šåƒä¸åƒå¾—ç²¾è‡´ï¼Œå…ˆåˆ«ç®¡ã€‚"
      },
      decide: {
        emoji:"ğŸ¤”",
        name:"ä½ æ¥å†³å®š",
        decide:"ç°åœ¨è¿™ç§æƒ…å†µï¼Œ\næ¥ä»½ä¸åã€ä¸åˆºæ¿€ã€ä¹Ÿä¸ç³Ÿç³•çš„ä¸€é¤ã€‚\nç¨³ä½å°±èµ¢ã€‚",
        accent:"linear-gradient(90deg, rgba(0,0,0,.06), rgba(29,116,255,.18))",
        ritual:"ç»™è‡ªå·±ä¸€ä¸ªå°æ‰¿è¯ºï¼šåƒå®Œå†åšä¸‹ä¸€ä»¶äº‹ã€‚"
      }
    };

    const STATE_BTNS = [
      { key:"tired",  hint:"çƒ­çš„ã€èƒ½é¡¶ä½" },
      { key:"sad",    hint:"ç†Ÿæ‚‰çš„é¥­ï¼Œç¨³ä¸€ä¸‹" },
      { key:"reward", hint:"ä»Šå¤©å€¼å¾—" },
      { key:"rush",   hint:"æœ€å¿«è§£å†³" },
      { key:"decide", hint:"æˆ‘æ¥æŒ‘ä¸€ä¸ªç¨³çš„" },
    ];

    /**********************
     * 1) D: èœå“æ•°æ®ï¼ˆ60ï¼‰ + æŠ½å–å¼•æ“
     **********************/
    function toKW(label){
      return label
        .replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, "")
        .replace(/\s*\+\s*/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    const DISHES = [
      // ğŸœ noodle 18
      { id:"N01", label:"æ¸…æ±¤ç‰›è‚‰é¢", cat:"noodle" },
      { id:"N02", label:"çº¢çƒ§ç‰›è‚‰é¢", cat:"noodle" },
      { id:"N03", label:"ç‰›è…©é¢", cat:"noodle" },
      { id:"N04", label:"æ’éª¨æ±¤é¢", cat:"noodle" },
      { id:"N05", label:"é¸¡æ±¤é¢", cat:"noodle" },
      { id:"N06", label:"é…¸èœè‚‰ä¸é¢", cat:"noodle" },
      { id:"N07", label:"é¦„é¥¨é¢", cat:"noodle" },
      { id:"N08", label:"æ—¥å¼è±šéª¨æ‹‰é¢", cat:"noodle" },
      { id:"N09", label:"æµ·é²œæ±¤é¢", cat:"noodle" },
      { id:"N10", label:"æ¸…æ±¤é¸¡ä¸é¢", cat:"noodle" },
      { id:"N11", label:"ç‚¸é…±é¢", cat:"noodle" },
      { id:"N12", label:"è‘±æ²¹æ‹Œé¢", cat:"noodle" },
      { id:"N13", label:"è¿‡æ²¹è‚‰æ‹Œé¢", cat:"noodle" },
      { id:"N14", label:"æ‹…æ‹…é¢", cat:"noodle" },
      { id:"N15", label:"ç‰›è‚‰æ‹Œé¢", cat:"noodle" },
      { id:"N16", label:"ç‰›è‚‰ç²‰ä¸æ±¤", cat:"noodle" },
      { id:"N17", label:"é…¸è¾£ç²‰", cat:"noodle" },
      { id:"N18", label:"å¹¿å¼ç‚’æ²³ç²‰", cat:"noodle" },

      // ğŸš rice 15
      { id:"R19", label:"é¸¡ä¸ + ç±³é¥­ï¼ˆä¸è¾£ï¼‰", cat:"rice" },
      { id:"R20", label:"ç•ªèŒ„ç‚’è›‹ + ç±³é¥­", cat:"rice" },
      { id:"R21", label:"é’æ¤’é¸¡è›‹ + ç±³é¥­", cat:"rice" },
      { id:"R22", label:"è±†è…ç‰›è‚‰ + ç±³é¥­ï¼ˆå¾®è¾£ï¼‰", cat:"rice" },
      { id:"R23", label:"é¸¡ä¸ + ç±³é¥­ï¼ˆå¾®è¾£ï¼‰", cat:"rice" },
      { id:"R24", label:"é…¸ç”œå£è‚‰ä¸ + ç±³é¥­", cat:"rice" },
      { id:"R25", label:"çº¢çƒ§ç‰›è‚‰ + ç±³é¥­ï¼ˆå¤šè‚‰ï¼‰", cat:"rice" },
      { id:"R26", label:"é»‘æ¤’ç‰›æŸ³ + ç±³é¥­", cat:"rice" },
      { id:"R27", label:"å’–å–±é¸¡ + ç±³é¥­", cat:"rice" },
      { id:"R28", label:"ç™½åˆ‡é¸¡ + ç±³é¥­ï¼ˆä¸æ²¹ä¸è¾£ï¼‰", cat:"rice" },
      { id:"R29", label:"æ¸…è’¸é±¼ + ç±³é¥­", cat:"rice" },
      { id:"R30", label:"é¸¡ä¸è”¬èœ + ç±³é¥­", cat:"rice" },
      { id:"R31", label:"æ–°ç–†æŠ“é¥­ï¼ˆç‰›è‚‰ï¼‰", cat:"rice" },
      { id:"R32", label:"ç…§çƒ§é¸¡è…¿ + ç±³é¥­", cat:"rice" },
      { id:"R33", label:"é»„ç„–é¸¡ + ç±³é¥­ï¼ˆåé‡å£ï¼‰", cat:"rice" },

      // ğŸ² soft 9
      { id:"S34", label:"çš®è›‹ç˜¦è‚‰ç²¥ï¼ˆçƒ­çš„ï¼‰", cat:"soft" },
      { id:"S35", label:"é¸¡ä¸ç²¥", cat:"soft" },
      { id:"S36", label:"å°ç±³ç²¥ + å°èœ", cat:"soft" },
      { id:"S37", label:"ç™½ç²¥ + å’¸èœ", cat:"soft" },
      { id:"S38", label:"å—ç“œç²¥", cat:"soft" },
      { id:"S39", label:"æ’éª¨æ±¤ + ç±³é¥­", cat:"soft" },
      { id:"S40", label:"ç•ªèŒ„ç‰›è…©æ±¤", cat:"soft" },
      { id:"S41", label:"ç´«èœè›‹èŠ±æ±¤ + ç±³é¥­", cat:"soft" },
      { id:"S42", label:"å†¬ç“œæ’éª¨æ±¤", cat:"soft" },

      // ğŸ” fast 9ï¼ˆå»é‡å¤ï¼‰
      { id:"F43", label:"ç»å…¸ç‰›è‚‰æ±‰å ¡", cat:"fast" },
      { id:"F44", label:"é¸¡è‚‰å·", cat:"fast" },
      { id:"F45", label:"ç«è…¿èŠå£«ä¸‰æ˜æ²»", cat:"fast" },
      { id:"F46", label:"é¦™çƒ¤ç‰›è‚‰ä¸‰æ˜æ²»ï¼ˆçƒ­ï¼‰", cat:"fast" },
      { id:"F47", label:"å¢¨è¥¿å“¥é¸¡è‚‰å·é¥¼", cat:"fast" },
      { id:"F48", label:"æŠ«è¨ï¼ˆå•äººä»½ï¼‰", cat:"fast" },
      { id:"F49", label:"ç‚¸é¸¡å¥—é¤", cat:"fast" },
      { id:"F51", label:"è–¯æ¡ + é¥®æ–™ï¼ˆåº”æ€¥ï¼‰", cat:"fast" },

      // ğŸ– heavy 6
      { id:"H52", label:"çº¢çƒ§æ’éª¨", cat:"heavy" },
      { id:"H53", label:"å›é”…è‚‰ + ç±³é¥­", cat:"heavy" },
      { id:"H54", label:"çƒ¤è‚‰æ‹Œé¥­", cat:"heavy" },
      { id:"H55", label:"éº»è¾£é¦™é”…", cat:"heavy" },
      { id:"H56", label:"çƒ§çƒ¤æ‹¼ç›˜", cat:"heavy" },
      { id:"H57", label:"ç‚¸çŒªæ’å¥—é¤", cat:"heavy" },

      // ğŸ° sweet 3
      { id:"T58", label:"å¥¶èŒ¶", cat:"sweet" },
      { id:"T59", label:"ææ‹‰ç±³è‹", cat:"sweet" },
      { id:"T60", label:"å†°æ·‡æ·‹", cat:"sweet" },
    ].map(d => ({ ...d, kw: toKW(d.label) }));

    const POOLS = {
      noodle: DISHES.filter(d=>d.cat==="noodle"),
      rice:   DISHES.filter(d=>d.cat==="rice"),
      soft:   DISHES.filter(d=>d.cat==="soft"),
      fast:   DISHES.filter(d=>d.cat==="fast"),
      heavy:  DISHES.filter(d=>d.cat==="heavy"),
      sweet:  DISHES.filter(d=>d.cat==="sweet"),
    };

    const WEIGHTS = {
      tired:  { noodle: 42, soft: 30, rice: 22, fast: 6,  heavy: 0,  sweet: 0 },
      sad:    { rice:   38, noodle: 32, soft: 18, fast: 6,  heavy: 0,  sweet: 6 },
      reward: { heavy:  34, fast:  28, noodle: 18, rice: 12, soft: 0,  sweet: 8 },
      rush:   { fast:   52, rice:  28, noodle: 12, soft: 8,  heavy: 0,  sweet: 0 },
      decide: { noodle: 40, rice:  34, soft: 20, fast: 6,  heavy: 0,  sweet: 0 },
    };

    function weightedPick(obj){
      const entries = Object.entries(obj).filter(([,w])=>w>0);
      const total = entries.reduce((s,[,w])=>s+w,0);
      let r = Math.random() * total;
      for(const [k,w] of entries){
        r -= w;
        if(r <= 0) return k;
      }
      return entries[entries.length-1][0];
    }
    function pickOne(arr, avoidId){
      if(!arr || arr.length===0) return null;
      if(!avoidId) return arr[Math.floor(Math.random()*arr.length)];
      const filtered = arr.filter(x=>x.id!==avoidId);
      const pickArr = filtered.length ? filtered : arr;
      return pickArr[Math.floor(Math.random()*pickArr.length)];
    }
    function pickByMood(moodKey, lastId){
      const w = WEIGHTS[moodKey] || WEIGHTS.decide;
      const cat = weightedPick(w);
      const dish = pickOne(POOLS[cat], lastId);
      return dish || pickOne(DISHES, lastId);
    }

    /**********************
     * 2) é¡µé¢é€»è¾‘
     **********************/
    const homeEl = document.getElementById("home");
    const resEl  = document.getElementById("result");
    const sticky = document.getElementById("sticky");
    const toast  = document.getElementById("toast");

    const stateGrid = document.getElementById("stateGrid");
    const backBtn = document.getElementById("backBtn");
    const goBtn   = document.getElementById("goBtn");
    const swapBtn = document.getElementById("swapBtn");
    const changeBtn = document.getElementById("changeBtn");

    const accentBar = document.getElementById("accentBar");
    const stateTitle = document.getElementById("stateTitle");
    const stateDecide = document.getElementById("stateDecide");
    const dishText = document.getElementById("dishText");
    const dishMeta = document.getElementById("dishMeta");
    const ritualBox = document.getElementById("ritualBox");

    let currentMood = null;
    let currentDish = null;
    let lastDishId  = null;
    let jumpedOut   = false;

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), 1500);
    }

    function setView(which){
      const isHome = (which === "home");
      homeEl.classList.toggle("active", isHome);
      resEl.classList.toggle("active", !isHome);
      sticky.classList.toggle("active", !isHome);
    }

    function renderResult(){
      const ui = STATE_UI[currentMood] || STATE_UI.decide;

      accentBar.style.background = ui.accent;
      stateTitle.textContent = `${ui.emoji} ${ui.name}`;
      stateDecide.textContent = ui.decide;

      dishText.textContent = currentDish?.label || "â€”";
      dishMeta.textContent = currentDish
        ? `å…³é”®è¯ï¼š${currentDish.kw} Â· åˆ†ç±»ï¼š${currentDish.cat}`
        : "â€”";

      ritualBox.innerHTML = `<b>ä»ªå¼æ„Ÿï¼ˆå¯é€‰ï¼‰</b>${ui.ritual}`;
      setView("result");
    }

    function onPickMood(key){
      currentMood = key;
      currentDish = pickByMood(currentMood, lastDishId);
      lastDishId = currentDish?.id || null;
      renderResult();
    }

    function swapDish(){
      currentDish = pickByMood(currentMood || "decide", lastDishId);
      lastDishId = currentDish?.id || null;

      // å°åŠ¨æ•ˆï¼šåˆ‡æ¢æ—¶æ–‡å­—æ·¡å‡ºæ·¡å…¥
      dishText.style.opacity = "0";
      dishMeta.style.opacity = "0";
      setTimeout(()=>{
        dishText.textContent = currentDish?.label || "â€”";
        dishMeta.textContent = currentDish
          ? `å…³é”®è¯ï¼š${currentDish.kw} Â· åˆ†ç±»ï¼š${currentDish.cat}`
          : "â€”";
        dishText.style.opacity = "1";
        dishMeta.style.opacity = "1";
      }, 90);
    }

    function goWaimai(){
  const kw = (currentDish?.kw || currentDish?.label || "").trim();
  if(!kw){
    showToast("å…ˆé€‰ä¸€ä¸ªå†å»ç‚¹å¤–å–ğŸ™‚");
    return;
  }

  jumpedOut = true;

  // âœ… ä¼˜å…ˆå”¤é†’ç¾å›¢å¤–å– Appï¼ˆä¸èµ°ç½‘é¡µï¼‰
  const appUrl = "meituanwaimai://waimai.meituan.com/search?query=" + encodeURIComponent(kw);

  // ç»™ç”¨æˆ·ä¸€ä¸ªå³æ—¶åé¦ˆ
  showToast("æ­£åœ¨æ‰“å¼€ç¾å›¢â€¦");

  // å°è¯•å”¤é†’ App
  window.location.href = appUrl;

  // âš ï¸ ä¸åšç½‘é¡µå…œåº•ï¼ˆæŒ‰ä½ è¦æ±‚ï¼‰
  // å¦‚æœä½ ä¹‹ååˆæƒ³è¦â€œå”¤é†’å¤±è´¥å°±å»ç½‘é¡µâ€ï¼Œæˆ‘å†ç»™ä½ åŠ ä¸€ä¸ªå¯å¼€å…³çš„ fallback
}

    // ä»å¤–å–å›æ¥ï¼Œå¼¹ä¸€å¥
    document.addEventListener("visibilitychange", ()=>{
      if(document.visibilityState === "visible" && jumpedOut){
        jumpedOut = false;
        showToast(Math.random() < 0.5 ? "å¤šåƒç‚¹ğŸ™‚" : "åƒé¥±äº†å°±å¼€å¿ƒå•¦âœ¨");
      }
    });

    // ç»‘å®šæŒ‰é’®
    backBtn.addEventListener("click", ()=>{ setView("home"); });
    swapBtn.addEventListener("click", swapDish);
    changeBtn.addEventListener("click", ()=>{ setView("home"); });
    goBtn.addEventListener("click", goWaimai);

    // ç”Ÿæˆé¦–é¡µæŒ‰é’®
    function buildHomeButtons(){
      stateGrid.innerHTML = "";
      STATE_BTNS.forEach(({key, hint})=>{
        const ui = STATE_UI[key];
        const btn = document.createElement("div");
        btn.className = "stateBtn";
        btn.innerHTML = `
          <div class="emojiCircle">${ui.emoji}</div>
          <div class="stateText">
            <div class="stateName">${ui.name}</div>
            <div class="stateHint">${hint}</div>
          </div>
        `;
        btn.addEventListener("click", ()=>onPickMood(key));
        stateGrid.appendChild(btn);
      });
    }

    buildHomeButtons();
    setView("home");

    /**********************
     * (å¯é€‰) Service Worker
     * å¦‚æœä½ ä»“åº“é‡Œå·²æœ‰ sw.jsï¼Œå°±ä¼šæ³¨å†Œï¼›æ²¡æœ‰ä¹Ÿä¸å½±å“ã€‚
     **********************/
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.getRegistrations().then(()=> {
        navigator.serviceWorker.register("sw.js").catch(()=>{});
      });
    }
  </script>
</body>
</html>
